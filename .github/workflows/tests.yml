name: Tests

# Run tests on push to any branch and on pull requests
on:
  push:
    branches: [ main, master, "claude/**" ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Test on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest

    strategy:
      # Test on multiple Python versions (3.8 EOL as of October 2024)
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
    # Step 1: Check out the code
    - name: Check out repository
      uses: actions/checkout@v4

    # Step 2: Set up Python
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    # Step 3: Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
        pip install -e .

    # Step 3b: Download spacy model
    - name: Download spacy language model
      run: |
        python -m spacy download en_core_web_sm
        python -c "import spacy; spacy.load('en_core_web_sm')"

    # Step 4: Run tests with pytest
    - name: Run tests
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        python -m pytest -ra --maxfail=1 --disable-warnings \
          --junitxml=pytest-${{ matrix.python-version }}.xml \
          --cov=src --cov-report=term

    # Step 4b: Upload test results
    - name: Upload pytest report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-report-${{ matrix.python-version }}
        path: pytest-${{ matrix.python-version }}.xml

    # Step 5: Check if tests passed
    - name: Test summary
      if: always()
      run: |
        echo "Tests completed for Python ${{ matrix.python-version }}"
